{% extends "base.html" %} {% block head %}
<style>
  :root {
    --background: #020817;
    --foreground: #fafafa;
    --muted: #171923;
    --muted-foreground: #a0aec0;
    --border: #2d3748;
    --input: #2d3748;
    --primary: #fff;
    --primary-foreground: #000;
    --message-user-bg: rgba(255, 255, 255, 0.03);
    --message-bot-bg: rgba(255, 255, 255, 0.06);
    --ring: rgba(255, 255, 255, 0.1);
  }

  body {
    background-color: var(--background);
    color: var(--foreground);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  }

  .chat-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .chat-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .chat-header h3 {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(to right, var(--foreground), #a0aec0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 1rem;
  }

  .chat-header p {
    color: var(--muted-foreground);
    font-size: 1.1rem;
  }

  .chat-card {
    background: var(--muted);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .chat-header-bar {
    background: var(--muted);
    border-bottom: 1px solid var(--border);
    padding: 1rem;
    font-weight: 600;
    color: var(--foreground);
  }

  .chat-messages {
    height: 500px;
    overflow-y: auto;
    padding: 1.5rem;
    scroll-behavior: smooth;
  }

  .message {
    max-width: 85%;
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 8px;
    animation: messageSlide 0.3s ease-out;
  }

  .message-user {
    background: var(--message-user-bg);
    margin-left: auto;
    border: 1px solid var(--border);
  }

  .message-bot {
    background: var(--message-bot-bg);
    margin-right: auto;
    border: 1px solid var(--border);
  }

  .message-sender {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: var(--muted-foreground);
  }

  .message-content {
    line-height: 1.5;
    color: var(--foreground);
  }

  .chat-input-container {
    padding: 1rem;
    background: var(--muted);
    border-top: 1px solid var(--border);
  }

  .chat-input-group {
    display: flex;
    gap: 0.5rem;
  }

  .chat-input {
    flex: 1;
    background: var(--message-user-bg);
    border: 1px solid var(--border);
    color: var(--foreground);
    padding: 0.8rem 1rem;
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .chat-input:focus {
    outline: none;
    border-color: var(--foreground);
    box-shadow: 0 0 0 1px var(--ring);
  }

  .chat-input::placeholder {
    color: var(--muted-foreground);
  }

  .send-button {
    background: var(--primary);
    color: var(--primary-foreground);
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .send-button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  .send-button:active {
    transform: translateY(0);
  }

  /* Custom scrollbar */
  .chat-messages::-webkit-scrollbar {
    width: 8px;
  }

  .chat-messages::-webkit-scrollbar-track {
    background: var(--muted);
  }

  .chat-messages::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
  }

  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: var(--input);
  }

  /* Loading indicator */
  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .typing-indicator.visible {
    opacity: 1;
  }

  .typing-dot {
    width: 6px;
    height: 6px;
    background: var(--muted-foreground);
    border-radius: 50%;
    animation: typingBounce 1s infinite;
  }

  @keyframes messageSlide {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes typingBounce {
    0%,
    60%,
    100% {
      transform: translateY(0);
    }
    30% {
      transform: translateY(-4px);
    }
  }
</style>

{% endblock %} {% block content %}
<div class="chat-container">
  <div class="chat-header">
    <h3>Hopf Chat Assistant</h3>
  </div>

  <div class="chat-card">
    <div class="chat-header-bar">Chat History</div>

    <div class="chat-messages" id="chatHistory">
      {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input-group" id="websocket-form">
        <input
          type="text"
          class="chat-input"
          placeholder="Type your message here..."
          id="userInput"
        />
        <button class="send-button" type="button" id="sendButton">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const ws = new WebSocket(`ws://${window.location.host}/ws`);
    const sendButton = document.getElementById("sendButton");
    const userInput = document.getElementById("userInput");
    const chatHistory = document.getElementById("chatHistory");
    const typingIndicator = document.getElementById("typingIndicator");

    ws.onerror = function () {
      chatHistory.innerHTML +=
        '<div class="alert alert-danger">Connection failed. Please refresh the page.</div>';
    };

    ws.onmessage = function (event) {
      const data = JSON.parse(event.data);
      typingIndicator.classList.remove("visible");

      if (data.error) {
        appendMessage("Error: " + data.error, "error");
        return;
      }

      if (data.bot) {
        appendMessage(data.bot, "bot", "Hopf Assistant");
      }
    };

    function appendMessage(message, type, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message message-${type}`;

      const senderDiv = document.createElement("div");
      senderDiv.className = "message-sender";
      senderDiv.textContent = sender;

      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";
      contentDiv.textContent = message;

      messageDiv.appendChild(senderDiv);
      messageDiv.appendChild(contentDiv);
      chatHistory.insertBefore(messageDiv, typingIndicator);

      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    function showTypingIndicator() {
      typingIndicator.classList.add("visible");
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    sendButton.onclick = function () {
      const message = userInput.value.trim();
      if (message) {
        appendMessage(message, "user", "You");
        showTypingIndicator();
        ws.send(message);
        userInput.value = "";
      }
    };

    userInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendButton.click();
      }
    });

    userInput.focus();
  });
</script>
{% endblock %}
